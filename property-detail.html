<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luxurious 3 BHK Flat in Sector 62 Noida | 24Dismil.com</title>
  <meta name="description"
    content="3 BHK apartment for sale at â‚¹85 Lakh in Sector 62, Noida. 1450 sq.ft, ready to move, swimming pool, gym, 24x7 security. RERA registered.">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/city-dropdown.css">
  <link rel="stylesheet" href="css/property-detail-new.css">
  <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
  <style>
    /* ---- Gallery skeleton shimmer ---- */
    .gallery-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0
      }

      100% {
        background-position: -200% 0
      }
    }

    .gallery-main img,
    .gallery-thumb img {
      transition: opacity 0.4s ease;
    }

    /* ---- Clickable gallery ---- */
    .gallery-main,
    .gallery-thumb {
      cursor: zoom-in;
    }

    /* ---- Lightbox ---- */
    #photolightbox {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.95);
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #photolightbox.open {
      display: flex;
      animation: lbFade 0.2s ease;
    }

    @keyframes lbFade {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    #lbClose {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 32px;
      color: #fff;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      z-index: 10;
      background: none;
      border: none;
      line-height: 1;
    }

    #lbClose:hover {
      opacity: 1;
    }

    #lbCounter {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    #lbMainImg {
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 4px;
      transition: opacity 0.25s;
    }

    #lbPrev,
    #lbNext {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: #fff;
      font-size: 28px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 10;
    }

    #lbPrev {
      left: 12px;
    }

    #lbNext {
      right: 12px;
    }

    #lbPrev:hover,
    #lbNext:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    #lbThumbs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      overflow-x: auto;
      max-width: 90vw;
      padding: 4px;
      scrollbar-width: thin;
    }

    .lb-thumb {
      width: 60px;
      height: 46px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s;
      flex-shrink: 0;
      border: 2px solid transparent;
    }

    .lb-thumb.active {
      opacity: 1;
      border-color: var(--primary, #e84b1e);
    }

    .lb-thumb:hover {
      opacity: 0.85;
    }
  </style>

  <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
</head>

<body>
  <!-- PHOTO LIGHTBOX MODAL -->
  <div id="photolightbox" role="dialog" aria-modal="true" aria-label="Photo viewer">
    <button id="lbClose" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    <div id="lbCounter">1 / 1</div>
    <button id="lbPrev" aria-label="Previous photo"><i class="fa-solid fa-chevron-left"></i></button>
    <img id="lbMainImg" src="" alt="Property photo">
    <button id="lbNext" aria-label="Next photo"><i class="fa-solid fa-chevron-right"></i></button>
    <div id="lbThumbs"></div>
  </div>

  <!-- ADVERTISER MODAL (Modern Redesign) -->
  <div class="adv-modal-overlay" id="advModal">
    <div class="adv-modal-content">
      <!-- Modern Header -->
      <div class="adv-header">
        <div class="adv-owner-profile">
          <div class="adv-avatar"><i class="fa-solid fa-user-lock"></i></div>
          <div class="adv-owner-details">
            <div class="adv-owner-name" id="advNameDisplay">Name Hidden</div>
            <div class="adv-owner-role">Property Owner</div>
            <div class="adv-owner-phone" id="advPhoneDisplay">+91 98*** 543**</div>
          </div>
        </div>
        <button class="adv-close" id="advModalClose"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <!-- Warning/Instruction -->
      <div class="adv-alert">
        <i class="fa-solid fa-shield-halved"></i> Please share your details to unlock the owner's contact info.
      </div>

      <!-- Body -->
      <div class="adv-body">
        <div class="adv-grid">

          <!-- Left Column: Primary Info -->
          <div class="adv-form-section">
            <h4 class="adv-title">Basic Information</h4>

            <div class="adv-group">
              <label class="adv-label">Property interested for?</label>
              <div class="adv-chips" id="chipReason">
                <div class="adv-chip" data-val="Investment">Investment</div>
                <div class="adv-chip active" data-val="Self Use">Self Use</div>
              </div>
              <input type="hidden" id="valReason" value="Self Use">
            </div>

            <div class="adv-group">
              <label class="adv-label">Are you a property dealer?</label>
              <div class="adv-chips" id="chipDealer">
                <div class="adv-chip" data-val="Yes">Yes</div>
                <div class="adv-chip active" data-val="No">No</div>
              </div>
              <input type="hidden" id="valDealer" value="No">
            </div>

            <div class="adv-input-row" style="margin-top:24px;">
              <div class="adv-input-wrap">
                <i class="fa-regular fa-user adv-input-icon"></i>
                <input type="text" id="advInputName" class="adv-input-text" placeholder="Your Full Name">
              </div>
            </div>

            <div class="adv-input-wrap">
              <i class="fa-solid fa-mobile-screen adv-input-icon"></i>
              <span class="adv-prefix">+91 IND</span>
              <input type="tel" id="advInputPhone" class="adv-input-text" placeholder="Mobile Number"
                style="padding-left:106px;">
            </div>
          </div>

          <!-- Right Column: Optional Info -->
          <div class="adv-form-section">
            <h4 class="adv-title">Additional Preferences</h4>

            <div class="adv-group">
              <label class="adv-label">Planning to buy in?</label>
              <div class="adv-chips" id="chipTimeframe">
                <div class="adv-chip" data-val="3 months">3 Months</div>
                <div class="adv-chip" data-val="6 months">6 Months</div>
                <div class="adv-chip active" data-val="More than 6 months">More than 6 months</div>
              </div>
              <input type="hidden" id="valTimeframe" value="More than 6 months">
            </div>

            <div class="adv-checks">
              <label class="adv-check-label">
                <input type="checkbox" id="advCheckLoan" class="adv-checkbox">
                <span class="adv-check-text">I am interested in Home Loan assistance</span>
              </label>
              <label class="adv-check-label">
                <input type="checkbox" id="advCheckVisit" class="adv-checkbox" checked>
                <span class="adv-check-text">I am interested in Site Visits</span>
              </label>
              <label class="adv-check-label" style="margin-top:12px;">
                <input type="checkbox" id="advCheckTerms" class="adv-checkbox">
                <span class="adv-check-text">I agree to the <a href="terms.html">Terms</a> & <a
                    href="privacy.html">Privacy Policy</a></span>
              </label>
            </div>

            <button class="adv-submit-btn" id="advBtnSubmit">Get Contact Details</button>
            <div id="advSuccessMsg" class="adv-success-box" style="display:none;">
              <i class="fa-solid fa-circle-check"></i> Details shared! Contact information is now visible above.
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple script to handle chip selection clicks securely without breaking scope
    document.addEventListener("DOMContentLoaded", () => {
      const chipGroups = [
        { id: 'chipReason', inputId: 'valReason' },
        { id: 'chipDealer', inputId: 'valDealer' },
        { id: 'chipTimeframe', inputId: 'valTimeframe' }
      ];

      chipGroups.forEach(group => {
        const wrap = document.getElementById(group.id);
        const input = document.getElementById(group.inputId);
        if (!wrap || !input) return;

        const chips = wrap.querySelectorAll('.adv-chip');
        chips.forEach(chip => {
          chip.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            input.value = chip.getAttribute('data-val');
          });
        });
      });
    });
  </script>

  <!-- HEADER -->

  <header class="header" id="header">
    <div class="container">
      <nav class="nav">
        <div class="nav-group nav-group-left">
          <a href="index.html" class="nav-logo">
            <div class="nav-logo-icon">24</div>
            <span class="nav-logo-text">24Dismil.com</span>
          </a>
          <button class="nav-city" id="citySelectorBtn">
            <i class="fa-solid fa-location-dot"></i>
            <span id="currentCityText">Select City</span>
            <i class="fa-solid fa-chevron-down" style="font-size: 0.8em"></i>
          </button>
        </div>

        <div class="nav-links">
          <a href="index.html" class="nav-link">Home</a>
          <a href="properties.html?type=buy" class="nav-link active">Buy</a>
          <a href="properties.html?type=rent" class="nav-link">Rent</a>
        </div>

        <div class="nav-group nav-group-right">
          <div class="nav-actions">
            <a href="login.html" class="nav-btn-login">Login / Register</a>
            <a href="post-property.html" class="nav-btn-post"><i class="fa-solid fa-plus"></i> Post FREE Property</a>
          </div>
          <div class="hamburger" id="hamburger">
            <span></span><span></span><span></span>
          </div>
        </div>
      </nav>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
      <a href="properties.html"><i class="fa-solid fa-magnifying-glass"></i> Properties</a>
      <a href="login.html" style="color: var(--primary); font-weight: 700"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
    </div>
  </header>

  <!-- PAGE BREADCRUMB BAR -->
  <!-- HERO COVER SECTION -->
  <section class="property-hero" id="propertyHero">
    <img src="images/property-1.webp" alt="Property Cover" class="hero-cover" id="heroCoverImg">
    <div class="hero-overlay">
      <div class="hero-content">
        <div class="hero-badges" id="heroBadges">
          <!-- Badges injected here -->
        </div>
        <div class="hero-price" id="heroPrice">â‚¹--</div>
        <h1 class="hero-title" id="heroTitle">Property Title</h1>
        <div class="hero-location" id="heroLocation">
          <i class="fa-solid fa-location-dot"></i> <span>Location details</span>
        </div>
      </div>
    </div>
  </section>

  <!-- BREADCRUMB -->
  <div style="background:#fff;border-bottom:1px solid var(--border);padding:14px 0;">
    <div class="container">
      <div class="page-breadcrumb" style="color:var(--text-muted)">
        <a href="index.html" style="color:var(--text-muted)">Home</a> <i class="fa-solid fa-chevron-right"
          style="font-size:10px"></i>
        <a href="properties.html" style="color:var(--text-muted)">Properties</a> <i class="fa-solid fa-chevron-right"
          style="font-size:10px"></i>
        <span style="color:var(--text)">Property Details</span>
      </div>
    </div>
  </div>

  <!-- MAIN DETAIL LAYOUT -->
  <div class="container">
    <div class="detail-layout">

      <!-- LEFT COLUMN -->
      <div>
        <!-- NEW GALLERY GRID -->
        <div class="detail-gallery-grid" id="galleryGrid">
          <div class="gallery-item gallery-main-item gallery-skeleton" id="galleryItem0">
            <img src="" alt="Main View" id="img0">
          </div>
          <div class="gallery-item gallery-skeleton" id="galleryItem1">
            <img src="" alt="View 2" id="img1">
          </div>
          <div class="gallery-item gallery-skeleton" id="galleryItem2" style="position:relative">
            <img src="" alt="View 3" id="img2">
            <div class="gallery-more-overlay" id="galleryMoreOverlay" style="display:none">+N Photos</div>
          </div>
        </div>

        <!-- KEY SPECS SECTION -->
        <div class="detail-section">
          <h2 class="section-title"><i class="fa-solid fa-list-check"></i> Property Highlights</h2>
          <div class="specs-grid" id="mainSpecsGrid">
            <!-- Dynamic Spec Cards (BHK, Area, Facing, Floor, etc.) -->
          </div>
        </div>

        <!-- DESCRIPTION SECTION -->
        <div class="detail-section">
          <h2 class="section-title"><i class="fa-solid fa-align-left"></i> Description</h2>
          <p id="dynamicDescription" style="font-size:15px;color:var(--text);line-height:1.8;white-space:pre-wrap;">
            No description provided.
          </p>
        </div>

        <!-- AMENITIES SECTION -->
        <div class="detail-section" id="amenitiesSection">
          <h2 class="section-title"><i class="fa-solid fa-star"></i> Amenities & Features</h2>
          <div class="amenities-grid">
            <!-- Dynamic Amenities -->
          </div>
        </div>

        <!-- FLOOR PLAN SECTION -->
        <div class="detail-section" id="floorPlanSection" style="display:none">
          <h2 class="section-title"><i class="fa-solid fa-draw-polygon"></i> Floor Plan</h2>
          <div class="floor-plan-container">
            <img src="" alt="Floor Plan" id="floorPlanImg" class="floor-plan-img">
          </div>
        </div>

        <!-- ADVANCED DETAILS TABLES -->
        <div id="advancedDetailsContainer">
            <!-- Dynamic Detailed Tables -->
        </div>

        <!-- LOCATION MAP -->
        <div class="detail-section">
          <h2 class="section-title"><i class="fa-solid fa-map-location-dot"></i> Location</h2>
          <div style="background:var(--bg);border-radius:12px;height:300px;display:flex;align-items:center;justify-content:center;border:2px dashed var(--border);flex-direction:column;gap:15px">
            <div style="font-size:48px; color:var(--primary)"><i class="fa-solid fa-location-arrow"></i></div>
            <p id="fullAddressText" style="font-size:15px;color:var(--text-muted); text-align:center; padding:0 20px"></p>
            <a href="#" target="_blank" id="googleMapsBtn" class="btn btn-primary btn-sm">Open in Google Maps â†—</a>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN â€” STICKY SIDEBAR -->
      <div class="sticky-sidebar">
        <!-- CONTACT WIDGET -->
        <div class="contact-widget">
          <h3>Interested?</h3>
          <p>Get instant contact details and schedule a direct site visit.</p>
          <button class="btn-white" id="btnOpenAdvModal">View Advertiser Details</button>
        </div>

        <!-- POSTED BY SECTION -->
        <div class="detail-section" style="margin-top:24px">
          <h3 style="font-size:16px;font-weight:700;margin-bottom:20px;color:var(--dark)">Listed By</h3>
          <div class="posted-by-card">
            <div id="ownerAvatar" class="poster-avatar" style="display:flex;align-items:center;justify-content:center;background:var(--primary);color:#fff;font-size:32px;font-weight:700">24</div>
            <div class="poster-details">
              <div class="poster-badge" id="posterBadge"><i class="fa-solid fa-user-check"></i> Individual</div>
              <h4 id="ownerName">Advertiser</h4>
              <p id="ownerJoinDate" style="font-size:13px;color:var(--text-muted)">Member since 2024</p>
              <div style="font-size:13px;color:var(--success);margin-top:4px"><i class="fa-solid fa-circle-check"></i> ID Verified</div>
            </div>
          </div>
          <div style="background:#f8fafc;border-radius:12px;padding:16px;font-size:13px;color:var(--text-muted);line-height:1.6;margin-top:20px;border:1px solid rgba(0,0,0,0.05)">
            <i class="fa-solid fa-lock"></i> Contact details are hidden for privacy. Click the button above to unlock.
          </div>
        </div>

        <!-- EMI CALCULATOR SMALL -->
        <div class="detail-section" style="margin-top:16px">
           <h3 style="font-size:16px;font-weight:700;margin-bottom:16px"><i class="fa-solid fa-calculator"></i> EMI Estimator</h3>
           <div id="emi-result-sidebar" style="font-size:24px;font-weight:800;color:var(--primary);margin-bottom:4px">â‚¹0</div>
           <div style="font-size:12px;color:var(--text-muted)">Est. monthly EMI @ 8.5%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SIMILAR PROPERTIES -->
  <section class="section" style="background:var(--bg)">
    <div class="container">
      <div class="section-header" style="text-align:left;margin-bottom:24px">
        <h2 style="font-size:22px">Similar Properties You May Like</h2>
      </div>
      <div class="cards-slider-wrap">
        <div class="cards-slider" id="similarPropertiesSlider">
          <!-- Dynamic Similar Properties will be injected here -->
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-brand">
          <div class="footer-logo">
            <div class="nav-logo-icon">24</div>
            24Dismil.com
          </div>
          <p class="footer-tagline">
            India's most trusted real estate portal. Find your dream property
            with verified listings, expert guidance, and market insights.
          </p>
          <div class="footer-socials">
            <a href="#" class="social-icon"><i class="fa-brands fa-facebook"></i></a>
            <a href="#" class="social-icon"><i class="fa-brands fa-instagram"></i></a>
            <a href="#" class="social-icon"><i class="fa-brands fa-twitter"></i></a>
            <a href="#" class="social-icon"><i class="fa-brands fa-linkedin"></i></a>
            <a href="#" class="social-icon"><i class="fa-brands fa-youtube"></i></a>
          </div>
        </div>
        <div class="footer-col">
          <h4>Quick Links</h4>
          <div class="footer-links">
            <a href="pricing.html">Pricing</a>
            <a href="properties.html?type=buy">Buy Properties</a>
            <a href="properties.html?type=rent">Rent Properties</a>
            <a href="properties.html?type=commercial">Commercial</a>
            <a href="post-property.html">Post Free Property</a>
            <a href="properties.html?newLaunch=true">New Projects</a>
            <a href="about.html">About Us</a>
            <a href="contact.html">Contact</a>
          </div>
        </div>
        <div class="footer-col">
          <h4>Resources</h4>
          <div class="footer-links">
            <a href="#">EMI Calculator</a>
            <a href="#">Property Rates</a>
            <a href="#">RERA Guide</a>
            <a href="#">Home Loan</a>
            <a href="#">Legal Guide</a>
            <a href="#">Vastu Tips</a>
            <a href="#">Blog & News</a>
            <a href="#">FAQ</a>
          </div>
        </div>
        <div class="footer-col footer-col-cities">
          <h4>Top Cities</h4>
          <div class="footer-links footer-cities-grid">
            <a href="properties.html?city=Mumbai">Mumbai</a>
            <a href="properties.html?city=Delhi NCR">Delhi NCR</a>
            <a href="properties.html?city=Bangalore">Bangalore</a>
            <a href="properties.html?city=Hyderabad">Hyderabad</a>
            <a href="properties.html?city=Pune">Pune</a>
            <a href="properties.html?city=Chennai">Chennai</a>
            <a href="properties.html?city=Kolkata">Kolkata</a>
            <a href="properties.html?city=Noida">Noida</a>
            <a href="properties.html?city=Ahmedabad">Ahmedabad</a>
            <a href="properties.html?city=Jaipur">Jaipur</a>
            <a href="properties.html?city=Patna">Patna</a>
            <a href="properties.html?city=Lucknow">Lucknow</a>
          </div>
        </div>
        <div class="footer-col footer-download">
          <h4>Post via Telegram</h4>
          <p class="footer-download-text">List your property in seconds using our automated bot.</p>
          <a href="https://t.me/DismilBot" target="_blank" class="footer-telegram-btn">
            <i class="fa-brands fa-telegram"></i> Start Posting
          </a>
          <div class="footer-badges">
            <span style="font-size: 11px; display: block; margin-bottom: 8px; color: rgba(255,255,255,0.4); font-weight: 600;">Mobile App (Coming Soon)</span>
            <div style="display: flex; gap: 8px; opacity: 0.6;">
              <a href="#" onclick="showToast('Coming Soon!', 'success'); return false;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Download_on_the_App_Store_Badge.svg" alt="Download on the App Store" class="app-badge" style="height: 28px;">
              </a>
              <a href="#" onclick="showToast('Coming Soon!', 'success'); return false;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play" class="app-badge" style="height: 28px;">
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <span>Â© 2025 24Dismil.com. All rights reserved. | India's #1 Real Estate Portal</span>
        <div class="footer-bottom-links">
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Use</a>
          <a href="#">Sitemap</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/properties.js"></script>
  <script src="js/main.js"></script>

  <script>
    // ---- Default Contact Button Handlers (static / demo fallback) ----
    // These run immediately and work even without a property ID in the URL.
    // When a real property loads from DB, these get overridden below.

    // Default contact number (shown when no property is loaded from DB)
    const DEFAULT_PHONE = '9999999999'; // Change this to your actual contact number

    document.getElementById('btnCallNow').addEventListener('click', function () {
      var phone = this.dataset.phone || DEFAULT_PHONE;
      window.location.href = 'tel:' + phone;
    });

    document.getElementById('btnWhatsApp').addEventListener('click', function () {
      var name = document.getElementById('contactName')?.value.trim() || '';
      var phone = this.dataset.phone || DEFAULT_PHONE;
      var msg = document.getElementById('contactMessage')?.value.trim() ||
        'Hi, I am interested in this property. Please contact me.';
      var text = encodeURIComponent((name ? 'Name: ' + name + '\n' : '') + msg);
      window.open('https://wa.me/91' + phone + '?text=' + text, '_blank');
    });

    document.getElementById('btnSendEnquiry').addEventListener('click', async function () {
      var name = document.getElementById('contactName')?.value.trim();
      var phone = document.getElementById('contactPhone')?.value.trim();
      var email = document.getElementById('contactEmail')?.value.trim();
      var message = document.getElementById('contactMessage')?.value.trim();
      var successMsg = document.getElementById('contactSuccess');
      var loader = document.getElementById('contactLoader');

      if (!name || !phone) {
        alert('Please enter your Name and Mobile Number.');
        return;
      }

      // If the DB-based handler has been attached (via module script below),
      // this default handler is replaced and won't run. But if no ?id= in URL
      // OR contactOwner mutation is unavailable, we show a friendly success.
      this.style.display = 'none';
      if (loader) loader.style.display = 'block';

      // Simulate small delay for UX
      await new Promise(r => setTimeout(r, 800));

      if (loader) loader.style.display = 'none';
      if (successMsg) successMsg.style.display = 'block';

      // Clear fields
      document.getElementById('contactName').value = '';
      document.getElementById('contactPhone').value = '';
      document.getElementById('contactEmail').value = '';
      document.getElementById('contactMessage').value = 'Hi, I am interested in this property. Please contact me.';

      var btn = this;
      setTimeout(function () {
        if (successMsg) successMsg.style.display = 'none';
        btn.style.display = 'inline-block';
      }, 5000);
    });

    // ---- NEW ADVERTISER MODAL FALLBACK LOGIC ----
    const advModal = document.getElementById('advModal');
    const btnOpenAdvModal = document.getElementById('btnOpenAdvModal');
    const advModalClose = document.getElementById('advModalClose');
    const advBtnSubmit = document.getElementById('advBtnSubmit');

    // Elements to update in modal header
    const advHeaderPhone = document.getElementById('advPhoneDisplay');
    const advHeaderName = document.getElementById('advNameDisplay');
    const advDateDisplay = document.getElementById('advDateDisplay');
    const advPriceAddress = document.getElementById('advPriceAddress');
    const advAreaType = document.getElementById('advAreaType');

    // Fallback defaults for static page
    let REAL_OWNER_PHONE = DEFAULT_PHONE;
    let REAL_OWNER_NAME = "Rajesh Kumar";
    let PROPERTY_ID = null;

    function maskPhone(phone) {
      if (!phone) return '+91 98***543**';
      return '+91 ' + phone.substring(0, 2) + '***' + phone.substring(5, 8) + '**';
    }

    if (btnOpenAdvModal) {
      btnOpenAdvModal.addEventListener('click', () => {
        advModal.classList.add('open');
        document.body.style.overflow = 'hidden';
        // Set masked phone and hidden name on open
        advHeaderPhone.textContent = maskPhone(REAL_OWNER_PHONE);
        advHeaderName.textContent = 'Name Hidden';
      });
    }

    function closeAdvModal() {
      advModal.classList.remove('open');
      document.body.style.overflow = '';

      // reset form states
      document.getElementById('advSuccessMsg').style.display = 'none';
      advBtnSubmit.style.display = 'block';
      advBtnSubmit.textContent = 'View Advertiser Details';
      advBtnSubmit.disabled = false;
    }

    if (advModalClose) advModalClose.addEventListener('click', closeAdvModal);
    if (advModal) {
      advModal.addEventListener('click', (e) => {
        if (e.target === advModal) closeAdvModal();
      });
    }

    // Fallback form submit
    if (advBtnSubmit) {
      advBtnSubmit.addEventListener('click', async function () {
        const nameEl = document.getElementById('advInputName');
        const phoneEl = document.getElementById('advInputPhone');
        const termsEl = document.getElementById('advCheckTerms');

        if (!nameEl.value.trim() || !phoneEl.value.trim()) {
          alert('Please enter your Name and Mobile Number.');
          return;
        }
        if (!termsEl.checked) {
          alert('Please agree to the Terms & Conditions.');
          return;
        }

        this.disabled = true;
        this.textContent = 'Submitting...';

        // Fallback submit delay
        await new Promise(r => setTimeout(r, 800));

        // Success UI update
        this.style.display = 'none';
        document.getElementById('advSuccessMsg').style.display = 'block';

        // Reveal owner details
        advHeaderPhone.textContent = '+91 ' + REAL_OWNER_PHONE;
        advHeaderName.textContent = REAL_OWNER_NAME;

        // Reset fields
        nameEl.value = '';
        phoneEl.value = '';
        termsEl.checked = false;
      });
    }

  </script>
  <script type="module">
    import { convex } from './js/convex.js';

    (async () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return; // no ID = show default hardcoded page

      try {
        const p = await convex.query('properties:getProperty', { id });
        if (!p) return;

        // ---- Resolve photo URLs (Robust version) ----
        const photos = (p.photos || []).map(item => {
          const url = typeof item === 'object' ? item.url : item;
          // Only return valid URL strings
          if (url && (typeof url === 'string' && (url.startsWith('http') || url.startsWith('/')))) {
            return url;
          }
          return null;
        }).filter(Boolean);
        if (photos.length === 0) photos.push('images/property-1.webp');

        // ---- Helpers ----
        const isLand = /plot|land/i.test(p.propertyType || '');
        const isCommercial = /commercial|shop|office|warehouse/i.test(p.propertyType || '');
        const bhk = p.details?.bhk;
        const price = p.pricing?.expectedPrice || 0;
        const area = p.details?.builtUpArea || 0;
        const priceStr = 'â‚¹' + price.toLocaleString('en-IN');
        const ppsf = area > 0 ? Math.round(price / area) : 0;

        function buildTag(icon, text, colorClass = 'primary') {
          return `<span class="badge badge-${colorClass}" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700"><i class="fa-solid ${icon}"></i> ${text}</span>`;
        }

        // Title
        let title = p.propertyType;
        if (!isLand && !isCommercial && bhk && bhk !== '0') title = `${bhk} BHK ${p.propertyType}`;

        // ---- Update page title / breadcrumb ----
        document.title = `${title} in ${p.location?.locality || p.location?.city} | 24Dismil.com`;
        
        const bcrumbSpan = document.querySelector('.page-breadcrumb span');
        if (bcrumbSpan) bcrumbSpan.textContent = title;

        // ---- Lightbox setup ----
        const lb = document.getElementById('photolightbox');
        const lbImg = document.getElementById('lbMainImg');
        const lbCounter = document.getElementById('lbCounter');
        const lbThumbs = document.getElementById('lbThumbs');
        let lbIndex = 0;

        function lbOpen(idx) {
          lbIndex = Math.max(0, Math.min(idx, photos.length - 1));
          lbImg.src = photos[lbIndex];
          lbCounter.textContent = `${lbIndex + 1} / ${photos.length}`;
          lbThumbs.querySelectorAll('.lb-thumb').forEach((t, i) => t.classList.toggle('active', i === lbIndex));
          lb.classList.add('open');
          document.body.style.overflow = 'hidden';
        }
        function lbClose() {
          lb.classList.remove('open');
          document.body.style.overflow = '';
        }
        function lbGo(delta) {
          lbOpen((lbIndex + delta + photos.length) % photos.length);
        }

        // Build thumbnail strip
        lbThumbs.innerHTML = photos.map((src, i) =>
          `<img class="lb-thumb ${i === 0 ? 'active' : ''}" src="${src}" data-idx="${i}" alt="Photo ${i + 1}">`
        ).join('');
        lbThumbs.querySelectorAll('.lb-thumb').forEach(t => {
          t.addEventListener('click', e => { e.stopPropagation(); lbOpen(parseInt(t.dataset.idx)); });
        });

        document.getElementById('lbClose').addEventListener('click', lbClose);
        document.getElementById('lbPrev').addEventListener('click', e => { e.stopPropagation(); lbGo(-1); });
        document.getElementById('lbNext').addEventListener('click', e => { e.stopPropagation(); lbGo(1); });
        lb.addEventListener('click', lbClose); // click backdrop to close
        lbImg.addEventListener('click', e => e.stopPropagation());
        document.addEventListener('keydown', e => {
          if (!lb.classList.contains('open')) return;
          if (e.key === 'ArrowLeft') lbGo(-1);
          if (e.key === 'ArrowRight') lbGo(1);
          if (e.key === 'Escape') lbClose();
        });
        // Touch swipe
        let touchStartX = 0;
        lb.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
        lb.addEventListener('touchend', e => {
          const dx = e.changedTouches[0].clientX - touchStartX;
          if (Math.abs(dx) > 50) lbGo(dx < 0 ? 1 : -1);
        });

        // ---- Load gallery thumbnails ----
        function loadImg(imgEl, wrapEl, src, photoIdx) {
          if (!imgEl) return;
          const tmp = new Image();
          tmp.onload = () => {
            imgEl.src = src;
            imgEl.style.opacity = '1';
            if (wrapEl) wrapEl.classList.remove('gallery-skeleton');
          };
          tmp.src = src;
          imgEl.style.cursor = 'zoom-in';
          imgEl.addEventListener('click', () => lbOpen(photoIdx));
        }

        // Wire gallery images
        if (mainImg) {
          mainImg.style.cursor = 'zoom-in';
          mainImg.addEventListener('click', () => lbOpen(0));
          const tmp = new Image();
          tmp.onload = () => { mainImg.src = photos[0]; mainImg.style.opacity = '1'; mainImg.parentElement?.classList.remove('gallery-skeleton'); };
          tmp.src = photos[0];
        }
        if (photos[1]) loadImg(galleryImg2, galleryThumb2, photos[1], 1);
        else if (galleryThumb2) galleryThumb2.style.display = 'none';

        if (photos[2]) loadImg(galleryImg3, galleryThumb3, photos[2], 2);
        else if (galleryThumb3) galleryThumb3.style.display = 'none';

        // "+N Photos" badge â€” dynamic count
        if (galleryMore) {
          const extra = photos.length - 3;
          if (extra > 0) {
            galleryMore.textContent = `+${extra} Photos`;
            galleryMore.style.display = '';
            galleryMore.style.cursor = 'pointer';
            galleryMore.addEventListener('click', () => lbOpen(3));
          } else {
            galleryMore.style.display = 'none';
          }
        }
        // Also make gallery-more on thumb3's parent open lightbox
        if (galleryThumb3) galleryThumb3.addEventListener('click', () => lbOpen(2));


        // ---- Price & Title card ----
        const priceEl = document.querySelector('.detail-price');
        if (priceEl) priceEl.textContent = priceStr;

        // ---- Update New Hero Section ----
        const heroCover = document.getElementById('heroCoverImg');
        const heroTitle = document.getElementById('heroTitle');
        const heroPrice = document.getElementById('heroPrice');
        const heroLocation = document.getElementById('heroLocation');
        const heroBadges = document.getElementById('heroBadges');

        if (heroCover && photos[0]) heroCover.src = photos[0];
        if (heroTitle) heroTitle.textContent = title;
        if (heroPrice) heroPrice.textContent = priceStr;
        if (heroLocation) heroLocation.querySelector('span').textContent = `${p.location?.locality || ''}, ${p.location?.city || ''}`;

        // Populate Hero Badges
        if (heroBadges) {
          const isRent = p.transactionType?.toLowerCase().includes('rent');
          let badgesHtml = buildTag(isRent ? 'fa-key' : 'fa-house', isRent ? 'RENT' : 'BUY', isRent ? 'warning' : 'primary');
          if (p.verified) badgesHtml += buildTag('fa-circle-check', 'Verified', 'verified');
          if (p.details?.status === 'Ready to Move' || p.status === 'ready') badgesHtml += buildTag('fa-check', 'Ready to Move', 'success');
          heroBadges.innerHTML = badgesHtml;
        }

        // ---- Update New Gallery Grid ----
        photos.forEach((src, i) => {
          if (i > 2) return;
          const img = document.getElementById(`img${i}`);
          const wrap = document.getElementById(`galleryItem${i}`);
          if (img) {
            img.src = src;
            img.onload = () => wrap && wrap.classList.remove('gallery-skeleton');
            img.addEventListener('click', () => lbOpen(i));
          }
        });

        // "+N Photos" overlay
        const galleryMoreOverlay = document.getElementById('galleryMoreOverlay');
        if (galleryMoreOverlay && photos.length > 3) {
          galleryMoreOverlay.textContent = `+${photos.length - 3} Photos`;
          galleryMoreOverlay.style.display = 'flex';
          galleryMoreOverlay.addEventListener('click', () => lbOpen(3));
        }

        // ---- Main Specs Grid (Highlights) ----
        const mainSpecsGrid = document.getElementById('mainSpecsGrid');
        if (mainSpecsGrid) {
          const highlights = [];
          if (!isLand && !isCommercial && bhk && bhk !== '0') highlights.push({ icon: 'fa-bed', val: `${bhk} BHK`, label: 'Bedrooms' });
          if (area > 0) highlights.push({ icon: 'fa-ruler-combined', val: `${area.toLocaleString('en-IN')} sq.ft`, label: 'Built-up Area' });
          if (p.details?.facing) highlights.push({ icon: 'fa-compass', val: p.details.facing, label: 'Facing' });
          if (!isLand && p.details?.floorNumber) highlights.push({ icon: 'fa-building', val: `${p.details.floorNumber}${p.details.totalFloors ? ' / ' + p.details.totalFloors : ''}`, label: 'Floor' });
          if (!isLand && p.details?.furnishing) highlights.push({ icon: 'fa-couch', val: p.details.furnishing, label: 'Furnishing' });
          if (p.details?.parking && p.details.parking !== 'None') highlights.push({ icon: 'fa-car', val: p.details.parking, label: 'Parking' });

          mainSpecsGrid.innerHTML = highlights.map(h => `
            <div class="spec-card">
              <div class="spec-icon"><i class="fa-solid ${h.icon}"></i></div>
              <div class="spec-info">
                <span class="spec-label">${h.label}</span>
                <span class="spec-value">${h.val}</span>
              </div>
            </div>
          `).join('');
        }

        // ---- Advanced Details (Categorized) ----
        const advancedContainer = document.getElementById('advancedDetailsContainer');
        if (advancedContainer) {
          let tablesHtml = '';
          
          // Helper for rows
          const renderRow = (label, val) => val ? `<div class="info-row"><span class="info-label">${label}</span><span class="info-value">${val}</span></div>` : '';

          // 1. Area & Orientation
          let areaRows = renderRow('Built-up Area', area > 0 ? `${area} sq.ft` : '');
          areaRows += renderRow('Carpet Area', p.details?.carpetArea ? `${p.details.carpetArea} sq.ft` : '');
          areaRows += renderRow('Facing', p.details?.facing);
          areaRows += renderRow('Road Width', p.details?.roadWidth ? `${p.details.roadWidth} ft` : '');
          
          if (areaRows) {
            tablesHtml += `
              <div class="detail-section">
                <h2 class="section-title"><i class="fa-solid fa-ruler-max"></i> Area & Orientation</h2>
                <div class="detail-info-grid">${areaRows}</div>
              </div>`;
          }

          // 2. Configuration & Features
          let configRows = renderRow('Bedrooms', bhk !== '0' ? bhk : '');
          configRows += renderRow('Bathrooms', p.details?.bathrooms);
          configRows += renderRow('Balconies', p.details?.balconies);
          configRows += renderRow('Furnishing', p.details?.furnishing);
          configRows += renderRow('Floor', p.details?.floorNumber ? `${p.details.floorNumber} of ${p.details.totalFloors || 'N/A'}` : '');
          
          if (configRows) {
            tablesHtml += `
              <div class="detail-section">
                <h2 class="section-title"><i class="fa-solid fa-house-chimney-window"></i> Configuration</h2>
                <div class="detail-info-grid">${configRows}</div>
              </div>`;
          }

          // 3. Construction & Legal
          let constructRows = renderRow('Property Status', p.details?.status);
          constructRows += renderRow('Built Year', p.details?.constructionYear);
          constructRows += renderRow('Ownership', p.details?.ownershipType);
          constructRows += renderRow('RERA ID', p.details?.rera);
          
          if (constructRows) {
            tablesHtml += `
              <div class="detail-section">
                <h2 class="section-title"><i class="fa-solid fa-gavel"></i> Construction & Records</h2>
                <div class="detail-info-grid">${constructRows}</div>
              </div>`;
          }

          advancedContainer.innerHTML = tablesHtml;
        }

        // ---- Description ----
        const descEl = document.getElementById('dynamicDescription');
        if (descEl && p.details?.description) {
          descEl.textContent = p.details.description;
        }

        // ---- Floor Plan ----
        const floorPlanSection = document.getElementById('floorPlanSection');
        const floorPlanImg = document.getElementById('floorPlanImg');
        const floorPlanPhoto = (p.photos || []).find(ph => ph.label === 'Floor Plan');
        if (floorPlanSection && floorPlanPhoto) {
          floorPlanImg.src = floorPlanPhoto.url;
          floorPlanSection.style.display = 'block';
        }

        // ---- Location Details ----
        const fullAddressText = document.getElementById('fullAddressText');
        if (fullAddressText) {
          fullAddressText.textContent = `${p.location?.society ? p.location.society + ', ' : ''}${p.location?.locality || ''}, ${p.location?.city || ''}, ${p.location?.state || ''} - ${p.location?.pinCode || ''}`;
        }
        const mapsBtn = document.getElementById('googleMapsBtn');
        if (mapsBtn) {
          const addr = encodeURIComponent(`${p.location?.locality || ''} ${p.location?.city || ''} ${p.location?.pinCode || ''}`);
          mapsBtn.href = `https://maps.google.com?q=${addr}`;
        }

        // ---- Sidebar EMI ----
        const emiResultSidebar = document.getElementById('emi-result-sidebar');
        if (emiResultSidebar && price > 500000) {
           const emi = Math.round((price * 0.8) * 0.008678);
           emiResultSidebar.textContent = `â‚¹${emi.toLocaleString('en-IN')}`;
        }

        // ---- Listed By (Owner/Company Info) ----
        if (p.ownerInfo) {
          const ownerAvatar = document.getElementById('ownerAvatar');
          const ownerName = document.getElementById('ownerName');
          const ownerJoinDate = document.getElementById('ownerJoinDate');
          const posterBadge = document.getElementById('posterBadge');
          
          const isCompany = p.ownerInfo.companyName && p.ownerInfo.companyName.trim() !== '';
          
          if (ownerName) ownerName.textContent = isCompany ? p.ownerInfo.companyName : p.ownerInfo.name;
          
          if (posterBadge) {
            posterBadge.innerHTML = isCompany ? 
              `<i class="fa-solid fa-building"></i> Company` : 
              `<i class="fa-solid fa-user-check"></i> Individual`;
          }

          if (ownerAvatar) {
            if (p.ownerInfo.profilePictureUrl) {
              ownerAvatar.innerHTML = `<img src="${p.ownerInfo.profilePictureUrl}" style="width:100%;height:100%;border-radius:20px;object-fit:cover;">`;
              ownerAvatar.style.background = 'transparent';
            } else {
              const initial = (isCompany ? p.ownerInfo.companyName : p.ownerInfo.name || 'U')[0].toUpperCase();
              ownerAvatar.innerHTML = initial;
            }
          }

          if (ownerJoinDate) {
            const memberSince = p.ownerInfo.joinedYear || 2024;
            const role = p.contactDesc?.role || (isCompany ? 'Agent' : 'Owner');
            ownerJoinDate.innerHTML = `<i class="fa-solid fa-user-tag"></i> ${role} Â· Member since ${memberSince}`;
          }
        }

        // ---- Amenities ----
        const amenGrid = document.querySelector('.amenities-grid');
        if (amenGrid && p.amenities?.length > 0) {
          const icons = {
            'Swimming Pool': 'ðŸŠ', 'Gym': 'ðŸ’ª', 'Clubhouse': 'ðŸ ', 'Security': 'ðŸ”’',
            'Power Backup': 'âš¡', 'Lift': 'ðŸ›—', 'Garden': 'ðŸŒ³', 'Parking': 'ðŸš—',
            'Play Area': 'ðŸŽ®', 'Fire Safety': 'ðŸ”¥', 'Intercom': 'ðŸ“¡', 'CCTV': 'ðŸ“¹',
            'WiFi': 'ðŸ“¶', 'Gas Pipeline': 'ðŸ”¥', 'Solar': 'â˜€ï¸'
          };
          amenGrid.innerHTML = p.amenities.map(a => {
            const icon = Object.entries(icons).find(([k]) => a.toLowerCase().includes(k.toLowerCase()))?.[1] || 'âœ…';
            return `<div class="amenity-item"><div class="amenity-icon">${icon}</div> ${a}</div>`;
          }).join('');
        } else if (amenGrid && (!p.amenities || p.amenities.length === 0)) {
          amenGrid.closest('.detail-card')?.remove(); // hide empty amenities section
        }

        // ---- Contact card ----
        if (p.contactDesc) {
          const ct = p.contactDesc;
          const sellerDiv = document.querySelector('.detail-card h3')?.closest('.detail-card');
          // Update seller info
          const sellerCard = document.querySelectorAll('.detail-card');
          sellerCard.forEach(card => {
            if (card.querySelector('h3')?.textContent.includes('Listed By')) {
              const nameEl = card.querySelector('div[style*="font-weight:700"]') || card.querySelector('.font-bold');
              const initial = document.querySelector('.detail-card div[style*="border-radius:50%"]');
              if (initial) initial.textContent = (ct.name || 'U')[0].toUpperCase();
              const rows = card.querySelectorAll('div[style*="font-weight:700"]');
              if (rows[0]) rows[0].textContent = ct.name || 'Owner';
              const roleEl = card.querySelector('div[style*="font-size:12px"]');
              if (roleEl) roleEl.textContent = `ðŸ  ${ct.role || 'Owner'} Â· Listed on 24Dismil.com`;
            }
          });

          // Update Call/WhatsApp buttons with real owner number from DB
          const callBtn = document.getElementById('btnCallNow');
          const waBtn = document.getElementById('btnWhatsApp');
          if (callBtn && ct.mobile) {
            callBtn.dataset.phone = ct.mobile;
            callBtn.onclick = () => window.location.href = `tel:${ct.mobile}`;
          }
          if (waBtn && ct.mobile) {
            waBtn.dataset.phone = ct.mobile;
            waBtn.onclick = () => {
              const msg = document.getElementById('contactMessage')?.value.trim() ||
                'Hi, I am interested in this property. Please contact me.';
              const name = document.getElementById('contactName')?.value.trim() || '';
              const text = encodeURIComponent((name ? 'Name: ' + name + '\n' : '') + msg);
              window.open(`https://wa.me/91${ct.mobile}?text=${text}`, '_blank');
            };
          }
        }

        // ---- Google Maps link ----
        const mapsLink = document.querySelector('a[href*="maps.google.com"]');
        if (mapsLink) {
          const addr = encodeURIComponent(`${p.location?.locality || ''} ${p.location?.city || ''} ${p.location?.state || ''} ${p.location?.pinCode || ''}`);
          mapsLink.href = `https://maps.google.com?q=${addr}`;
        }
        const mapText = document.querySelector('[href*="maps.google.com"]')?.previousElementSibling;
        if (mapText) mapText.textContent = `${p.location?.locality || ''}, ${p.location?.city || ''} ${p.location?.pinCode || ''}`;

        // ---- Populate Modal Header Details ----
        PROPERTY_ID = id;
        if (p.contactDesc) {
          REAL_OWNER_PHONE = p.contactDesc.mobile;
          REAL_OWNER_NAME = p.contactDesc.name || 'Owner';
        }

        // Format Date from property creation (if we have access to _creationTime from convex)
        const creationDate = p._creationTime ? new Date(p._creationTime).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Recently';
        if (advDateDisplay) advDateDisplay.textContent = `Posted On: ${creationDate}`;

        // Format Price & Address
        const shortAddress = `${p.location?.locality || ''}, ${p.location?.city || ''}`;
        let formattedPrice = 'Price on Request';
        if (price > 0) {
          if (price >= 10000000) formattedPrice = `â‚¹${(price / 10000000).toFixed(2)} Cr`;
          else if (price >= 100000) formattedPrice = `â‚¹${(price / 100000).toFixed(2)} Lac`;
          else formattedPrice = priceStr;
        }
        if (advPriceAddress) advPriceAddress.textContent = `${formattedPrice} | ${shortAddress}`;

        // Format Area & Type
        const areaStr = area > 0 ? `${area.toLocaleString('en-IN')} SQ.FT.` : '';
        const propTypeStr = p.propertyType ? p.propertyType.toUpperCase() : '';
        if (advAreaType) advAreaType.textContent = `${areaStr} | ${propTypeStr}`;

        // ---- Override Modal Submit for Real DB Submit ----
        const newAdvSubmit = advBtnSubmit.cloneNode(true);
        advBtnSubmit.parentNode.replaceChild(newAdvSubmit, advBtnSubmit);

        newAdvSubmit.addEventListener('click', async function () {
          const name = document.getElementById('advInputName').value.trim();
          const phone = document.getElementById('advInputPhone').value.trim();
          const termsChecked = document.getElementById('advCheckTerms').checked;

          // Extract Chip values
          const reason = document.getElementById('valReason')?.value || '';
          const dealer = document.getElementById('valDealer')?.value || '';
          const timeframe = document.getElementById('valTimeframe')?.value || '';
          const loan = document.getElementById('advCheckLoan').checked ? 'Yes' : 'No';
          const visit = document.getElementById('advCheckVisit').checked ? 'Yes' : 'No';

          if (!name || !phone) {
            alert('Please enter your Name and Mobile Number.');
            return;
          }
          if (!termsChecked) {
            alert('Please agree to the Terms & Conditions.');
            return;
          }

          this.disabled = true;
          this.textContent = 'Submitting...';

          // Format payload into single message string
          const fullMessage = `
--- Advertiser Modal Enquiry ---
Reason to Buy: ${reason}
Property Dealer: ${dealer}
Planning to Buy In: ${timeframe}
Interested in Home Loan: ${loan}
Interested in Site Visit: ${visit}
      `.trim();

          try {
            await convex.mutation('properties:contactOwner', {
              propertyId: PROPERTY_ID,
              name,
              phone,
              email: '', // Not collected in this modal
              message: fullMessage
            });

            // UI Success state
            this.style.display = 'none';
            document.getElementById('advSuccessMsg').style.display = 'block';

            // Reveal Owner Details!
            advHeaderPhone.textContent = '+91 ' + REAL_OWNER_PHONE;
            advHeaderName.textContent = REAL_OWNER_NAME;

            // Clear only core inputs, keep preferences
            document.getElementById('advInputName').value = '';
            document.getElementById('advInputPhone').value = '';
            document.getElementById('advCheckTerms').checked = false;

          } catch (err) {
            alert('Failed to send enquiry: ' + err.message);
            this.disabled = false;
            this.textContent = 'Get Contact Details';
          }
        });

        // Keep OLD Handle Contact Owner Form valid for DOM safety
        const btnSendEnquiry = document.getElementById('btnSendEnquiry');
        if (btnSendEnquiry) {
          // Remove fallback listener and replace with DB-backed version
          const newBtn = btnSendEnquiry.cloneNode(true);
          btnSendEnquiry.parentNode.replaceChild(newBtn, btnSendEnquiry);

          newBtn.addEventListener('click', async () => {
            const name = document.getElementById('contactName')?.value.trim();
            const phone = document.getElementById('contactPhone')?.value.trim();
            const email = document.getElementById('contactEmail')?.value.trim();
            const message = document.getElementById('contactMessage')?.value.trim();
            const successMsg = document.getElementById('contactSuccess');
            const loader = document.getElementById('contactLoader');

            if (!name || !phone) {
              alert('Name aur Mobile Number zaroori hai.');
              return;
            }

            newBtn.style.display = 'none';
            if (loader) loader.style.display = 'block';

            try {
              await convex.mutation('properties:contactOwner', {
                propertyId: id,
                name, phone, email: email || '', message: message || ''
              });
              if (loader) loader.style.display = 'none';
              if (successMsg) successMsg.style.display = 'block';

              // Clear inputs
              document.getElementById('contactName').value = '';
              document.getElementById('contactPhone').value = '';
              document.getElementById('contactEmail').value = '';
              document.getElementById('contactMessage').value = 'Hi, I am interested in this property. Please contact me.';

              setTimeout(() => {
                if (successMsg) successMsg.style.display = 'none';
                newBtn.style.display = 'inline-block';
              }, 5000);

            } catch (err) {
              alert('Enquiry bhejne mein error: ' + err.message);
              newBtn.style.display = 'inline-block';
              if (loader) loader.style.display = 'none';
            }
          });
        }

        // ---- EMI seed value ----
        const emiLoan = document.getElementById('emi-loan');
        if (emiLoan && price > 0) {
          emiLoan.value = Math.round(price * 0.8); // 80% as loan
          emiLoan.dispatchEvent(new Event('input'));
        }

        // ---- Similar Properties ----
        try {
          const allProps = await convex.query('properties:getProperties', {}) || [];
          const similar = allProps
            .filter(item => item._id !== id && item.id !== id) // Exclude current
            .filter(item => (item.location?.city === p.location?.city) || (item.propertyType === p.propertyType))
            .slice(0, 4); // Take up to 4

          const slider = document.getElementById('similarPropertiesSlider');
          if (slider && similar.length > 0) {
            let htmlStr = '';
            for (const sp of similar) {
              const spPrice = sp.pricing?.expectedPrice || 0;
              let spPriceStr = 'Price on Request';
              if (spPrice > 0) {
                if (spPrice >= 10000000) spPriceStr = `â‚¹${(spPrice / 10000000).toFixed(2)} Cr`;
                else if (spPrice >= 100000) spPriceStr = `â‚¹${(spPrice / 100000).toFixed(2)} Lac`;
                else spPriceStr = `â‚¹${spPrice.toLocaleString('en-IN')}`;
              }

              let spPhoto = 'images/property-1.webp';
              if (sp.photos && sp.photos[0]) {
                spPhoto = (typeof sp.photos[0] === 'object' ? sp.photos[0].url : sp.photos[0]) || spPhoto;
              }

              let spTitle = sp.propertyType || 'Property';
              if (!/plot|land|commercial|shop/i.test(spTitle) && sp.details?.bhk && sp.details.bhk !== '0') {
                spTitle = `${sp.details.bhk} BHK ${spTitle}`;
              }

              htmlStr += `
                  <div class="property-card" style="min-width:280px;flex-shrink:0;cursor:pointer;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;transition:transform 0.2s" onclick="window.location.href='property-detail.html?id=${sp._id || sp.id}'" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="prop-img-wrap" style="position:relative"><img src="${spPhoto}" alt="${spTitle}" loading="lazy" style="height:200px;object-fit:cover;width:100%">
                      <div class="prop-type-badge" style="position:absolute;top:10px;left:10px"><span class="badge ${sp.type === 'rent' ? 'badge-warning' : 'badge-primary'}" style="background:var(--primary);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:700">${sp.type === 'rent' ? 'RENT' : 'BUY'}</span></div>
                      ${sp.verified ? '<div class="prop-verified" style="position:absolute;bottom:10px;left:10px;background:rgba(16,185,129,0.9);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600"><i class="fa-solid fa-circle-check"></i> Verified</div>' : ''}
                    </div>
                    <div class="prop-body" style="padding:16px">
                      <div class="prop-price" style="font-size:20px;font-weight:800;color:var(--primary);margin-bottom:4px">${spPriceStr}</div>
                      <div class="prop-title" style="font-size:15px;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${spTitle}</div>
                      <div class="prop-location" style="color:var(--text-muted);font-size:13px;margin:8px 0"><i class="fa-solid fa-location-dot"></i> ${sp.location?.locality || ''}, ${sp.location?.city || ''}</div>
                      <div class="prop-specs" style="display:flex;gap:12px;font-size:13px;color:var(--text-muted);border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
                        ${sp.details?.bhk ? `<div><i class="fa-solid fa-bed"></i> ${sp.details.bhk} BHK</div>` : ''}
                        ${sp.details?.builtUpArea ? `<div><i class="fa-solid fa-ruler-combined"></i> ${sp.details.builtUpArea} sq.ft</div>` : ''}
                      </div>
                    </div>
                  </div>
                `;
            }
            slider.innerHTML = htmlStr;
          } else if (slider) {
            slider.parentElement.parentElement.style.display = 'none';
          }
        } catch (e) {
          console.error('Failed to load similar properties', e);
          const slider = document.getElementById('similarPropertiesSlider');
          if (slider) slider.parentElement.parentElement.style.display = 'none';
        }

      } catch (err) {
        console.error('Failed to load property details:', err);
      }
    })();
  </script>
<script src="js/city-selector.js"></script>

</body>

</html>