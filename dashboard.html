<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Dashboard | 24Dismil.com</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { background: var(--bg); }
    .dash-layout { display: flex; min-height: calc(100vh - 74px); margin-top: 74px; }
    .dash-sidebar { width: 260px; background: #fff; border-right: 1px solid var(--border); padding: 24px 0; flex-shrink: 0; }
    .dash-nav-item { padding: 14px 24px; display: flex; align-items: center; gap: 12px; color: var(--text); text-decoration: none; font-weight: 600; font-size: 14px; border-left: 3px solid transparent; cursor: pointer; transition: all 0.2s; }
    .dash-nav-item i { width: 20px; text-align: center; }
    .dash-nav-item:hover, .dash-nav-item.active { background: rgba(232, 65, 24, 0.05); color: var(--primary); border-left-color: var(--primary); }
    
    .dash-content-wrap { flex: 1; padding: 32px 40px; overflow-y: auto; }
    .dash-section { display: none; }
    .dash-section.active { display: block; }
    .dash-header { background: linear-gradient(135deg, var(--primary), #ff6b4a); border-radius: var(--radius); padding: 32px; color: #fff; margin-bottom: 28px; }
    .dash-header h1 { font-size: 24px; margin-bottom: 6px; }
    .dash-header p { opacity: 0.9; font-size: 14px; margin: 0; }
    
    .dash-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
    .dash-stat-card { background: #fff; border-radius: var(--radius-sm); padding: 24px 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); text-align: center; }
    .dash-stat-num { font-size: 32px; font-weight: 800; color: var(--primary); }
    .dash-stat-label { font-size: 13px; color: var(--text-muted); margin-top: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .dash-card { background: #fff; border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 24px; }
    .dash-card-title { font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    
    .dash-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .dash-form-group { display: flex; flex-direction: column; gap: 8px; }
    .dash-form-group.full { grid-column: 1 / -1; }
    .dash-label { font-size: 13px; font-weight: 600; color: var(--dark); }
    .dash-input { padding: 12px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 14px; outline: none; background: #fff; width: 100%; box-sizing: border-box; }
    .dash-input:focus { border-color: var(--primary); }
    .dash-btn { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; }
    .dash-btn:hover { opacity: 0.9; }
    .dash-btn-outline { background: transparent; color: var(--dark); border: 1px solid var(--border); }
    
    .table-wrap { overflow-x: auto; margin: -10px; padding: 10px; }
    .dash-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 14px; min-width: 600px; }
    .dash-table th { padding: 14px 16px; background: #F3F4F6; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid var(--border); }
    .dash-table td { padding: 16px; border-bottom: 1px solid var(--border); color: var(--dark); vertical-align: middle; }
    
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; display: inline-block; }
    .badge.success { background: #D1FAE5; color: #065F46; }
    .badge.pending { background: #FEF3C7; color: #92400E; }
    .badge.danger { background: #FEE2E2; color: #B91C1C; }
    .badge.primary { background: rgba(232, 65, 24, 0.1); color: var(--primary); }
    
    .progress-bar-bg { background: var(--bg); border-radius: 99px; height: 8px; overflow: hidden; margin-top: 12px; }
    .progress-bar-fill { background: var(--primary); height: 100%; border-radius: 99px; transition: width 0.5s; }
    
    .dash-empty { text-align: center; padding: 48px 20px; border: 1px dashed var(--border); border-radius: var(--radius); color: var(--text-muted); margin-top:16px;}
    
    .dash-prop-card { background: #fff; border-radius: var(--radius-sm); border: 1px solid var(--border); padding: 16px; display: flex; gap: 16px; align-items: center; margin-bottom: 16px; transition: 0.2s; }
    .dash-prop-card:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }
    .dash-prop-img { width: 120px; height: 90px; border-radius: 8px; object-fit: cover; flex-shrink: 0; background: var(--bg); }
    .dash-prop-info { flex: 1; }
    .dash-prop-title { font-size: 16px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
    .dash-prop-loc { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }
    .dash-prop-actions { display: flex; gap: 8px; margin-top: 12px; }
    .dash-action-btn { font-size: 12px; font-weight: 600; padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); color: var(--dark); text-decoration: none; cursor: pointer; background: #fff; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .dash-action-btn:hover { background: var(--bg); border-color: var(--primary); color: var(--primary); }
    .dash-action-btn.danger:hover { background: #fee2e2; border-color: #ef4444; color: #ef4444; }
    
    .prop-status-tag { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 12px; margin-top: 8px; display: inline-block; }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-expiry { background: #fef3c7; color: #92400e; }
    .status-featured { background: rgba(232, 65, 24, 0.1); color: var(--primary); border: 1px solid var(--primary); }
    
    .notify-item { padding: 16px 0; border-bottom: 1px solid var(--border); display: flex; gap: 16px; align-items: flex-start; }
    .notify-item:last-child { border-bottom: none; padding-bottom: 0; }
    .notify-icon { width: 40px; height: 40px; border-radius: 50%; background: #E0E7FF; color: #4F46E5; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; }
    .notify-content p { margin: 0 0 4px; font-size: 14px; color: var(--dark); font-weight: 500; }
    .notify-content span { font-size: 12px; color: var(--text-muted); }
    
    .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
    .setting-info h4 { font-size: 15px; font-weight: 600; color: var(--dark); margin: 0 0 4px; }
    .setting-info p { font-size: 13px; color: var(--text-muted); margin: 0; }
    
    /* Toggle switch */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Leads Redesign */
    .lead-card { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-sm); transition: 0.2s; position: relative; overflow: hidden; }
    .lead-card:hover { border-color: var(--primary); box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .lead-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    .lead-avatar { width: 52px; height: 52px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #ff6b4a); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(232, 65, 24, 0.2); }
    .lead-user-info { flex: 1; }
    .lead-user-info h3 { font-size: 18px; font-weight: 700; color: var(--dark); margin: 0 0 4px; }
    .lead-time { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
    
    .lead-body { border-top: 1px solid #f1f5f9; padding-top: 16px; }
    .lead-prop-link { background: #f8fafc; padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; text-decoration: none; border: 1px solid #e2e8f0; transition: 0.2s; }
    .lead-prop-link:hover { background: #fff; border-color: var(--primary); }
    .lead-prop-link i { color: var(--primary); font-size: 16px; }
    .lead-prop-title-text { font-size: 14px; font-weight: 600; color: var(--dark); flex: 1; }
    
    .lead-meta { display: flex; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
    .lead-meta-item { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text); text-decoration: none; font-weight: 500; }
    .lead-meta-item i { color: #64748b; font-size: 14px; width: 16px; text-align: center; }
    .lead-meta-item:hover { color: var(--primary); }
    
    .lead-msg-box { background: #fffaf5; border-left: 4px solid var(--primary); padding: 14px 18px; border-radius: 4px; font-size: 14px; color: #475569; line-height: 1.6; margin-bottom: 20px; position: relative; }
    .lead-msg-box::before { content: '"'; position: absolute; left: 6px; top: 0; font-size: 32px; color: var(--primary); opacity: 0.2; font-family: serif; }
    
    .lead-footer-actions { display: flex; gap: 12px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px; }
    .lead-action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 700; text-decoration: none; transition: 0.3s; border: none; cursor: pointer; }
    .btn-call-lead { background: #10B981; color: #fff; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.2); }
    .btn-call-lead:hover { background: #059669; transform: translateY(-2px); }
    .btn-wa-lead { background: #25D366; color: #fff; box-shadow: 0 4px 14px rgba(37, 211, 102, 0.2); }
    .btn-wa-lead:hover { background: #128C7E; transform: translateY(-2px); }

    .enquiry-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .enquiry-chip { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; display: flex; flex-direction: column; gap: 4px; }
    .enquiry-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .enquiry-value { font-size: 13px; font-weight: 600; color: var(--dark); }
    .enquiry-raw-msg { font-size: 14px; line-height: 1.6; color: #475569; padding: 16px; background: #fffaf5; border-radius: 10px; border-left: 4px solid var(--primary); margin-bottom: 20px; }

    @media(max-width: 900px) { 
      .dash-layout { flex-direction: column; } 
      .dash-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border); display: flex; flex-direction: row; overflow-x: auto; padding: 0; } 
      .dash-nav-item { white-space: nowrap; padding: 16px 20px; border-left: none; border-bottom: 3px solid transparent; } 
      .dash-nav-item.active { border-left: none; border-bottom-color: var(--primary); background: transparent; } 
      .dash-content-wrap { padding: 20px 16px; } 
      .dash-stats { grid-template-columns: 1fr; } 
      .dash-form-grid { grid-template-columns: 1fr; } 
      .dash-prop-card { flex-direction: column; align-items: flex-start; }
      .dash-prop-img { width: 100%; height: 160px; }
    }
  </style>
  <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet" />
</head>
<body>

<!-- HEADER -->
<header class="header" id="header">
  <div class="container">
    <nav class="nav">
      <a href="index.html" class="nav-logo">
        <div class="nav-logo-icon">24</div>
        <span class="nav-logo-text">24Dismil.com</span>
      </a>
      <button class="nav-city" id="citySelectorBtn">
        <i class="fa-solid fa-location-dot"></i> Delhi NCR <i class="fa-solid fa-chevron-down" style="font-size: 0.8em;"></i>
      </button>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="properties.html?type=buy" class="nav-link">Buy</a>
        <a href="properties.html?type=rent" class="nav-link">Rent</a>
        <a href="properties.html?type=commercial" class="nav-link">Commercial</a>
        
      </div>
      <div class="nav-actions">
        <a href="dashboard.html" class="nav-btn-login" id="dashNavName">My Account</a>
      </div>
      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>
    </nav>
  </div>
  <div class="mobile-menu" id="mobileMenu">
    <a href="index.html"><i class="fa-solid fa-house"></i> Home</a>
    <a href="properties.html?type=buy"><i class="fa-solid fa-cart-shopping"></i> Buy Property</a>
    <a href="properties.html?type=rent"><i class="fa-solid fa-key"></i> Rent Property</a>
    <a href="properties.html?type=commercial"><i class="fa-solid fa-building"></i> Commercial</a>
    
    <a href="login.html" style="color: var(--primary); font-weight: 700"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
  </div>
</header>

<!-- DASHBOARD -->
<!-- CROP MODAL -->
<div class="modal-overlay" id="cropModalOverlay" style="z-index: 2000;">
  <div class="payment-modal" style="max-width:500px">
    <h3 style="margin-bottom:16px"><i class="fa-solid fa-crop-simple"></i> Adjust Photo</h3>
    <div style="width: 100%; max-height: 400px; margin-bottom: 20px;">
      <img id="cropImage" src="" style="max-width:100%; display:block;">
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button class="dash-btn dash-btn-outline" id="btnCancelCrop">Cancel</button>
      <button class="dash-btn" id="btnApplyCrop">Apply & Upload</button>
    </div>
  </div>
</div>

<div class="container">
<div class="dash-layout" id="dashWrap" style="display:none">
  <!-- SIDEBAR -->
  <div class="dash-sidebar">
    <div class="dash-nav-item active" data-section="dashboard"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
    <div class="dash-nav-item" data-section="profile"><i class="fa-solid fa-user"></i> My Profile</div>
    <div class="dash-nav-item" data-section="properties"><i class="fa-solid fa-house"></i> My Properties</div>
    <div class="dash-nav-item" data-section="leads"><i class="fa-solid fa-address-card"></i> My Leads</div>
    <div class="dash-nav-item" data-section="plans"><i class="fa-solid fa-star"></i> Plan & Subscriptions</div>
    <div class="dash-nav-item" data-section="payments"><i class="fa-solid fa-receipt"></i> Payment History</div>
    <div class="dash-nav-item" data-section="rera"><i class="fa-solid fa-shield-halved"></i> RERA Verification</div>
    <div class="dash-nav-item" data-section="notifications"><i class="fa-solid fa-bell"></i> Notifications</div>
    <div class="dash-nav-item" data-section="settings"><i class="fa-solid fa-gear"></i> Settings</div>
    <!-- Logout at bottom of sidebar -->
    <div style="padding: 16px 0 0; margin-top: auto; border-top: 1px solid var(--border);">
      <div id="logoutBtn" class="dash-nav-item" style="color: #ef4444; cursor:pointer;">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="dash-content-wrap">
  
    <!-- Section 1: Dashboard Overview -->
    <div class="dash-section active" id="sec-dashboard">
      <div class="dash-header">
        <h1 id="dashGreeting">Welcome back! <i class="fa-solid fa-hand"></i></h1>
        <p id="dashEmail"></p>
      </div>

      <div class="dash-stats">
        <div class="dash-stat-card">
          <div class="dash-stat-num" id="statPosted">0</div>
          <div class="dash-stat-label">Properties Posted</div>
        </div>
        <div class="dash-stat-card">
          <div class="dash-stat-num" id="statFreeLeft">3</div>
          <div class="dash-stat-label">Free Listings Left</div>
        </div>
        <div class="dash-stat-card">
          <div class="dash-stat-num" id="tierIconContainer"><i class="fa-solid fa-tag"></i></div>
          <div class="dash-stat-label">Current Plan</div>
        </div>
      </div>

      <div class="dash-card">
        <div class="dash-card-title">
          <span>Free listing usage (<span id="usageText" style="color:var(--primary)">0 of 3 used</span>)</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="usageBar" style="width:0%"></div>
        </div>
        <p style="font-size:13px;color:var(--text-muted);margin-top:10px;margin-bottom:0">Upgrade to Premium for unlimited listings, priority placement & verified badge.</p>
        
        <div class="upgrade-card" id="upgradeCard" style="display:none; background: linear-gradient(135deg, #1A1A2E, #16213E); border-radius: var(--radius); padding: 28px; color: #fff; text-align: center; margin-top: 24px;">
          <h3 style="font-size: 20px; margin-bottom: 8px;"><i class="fa-solid fa-bolt"></i> Unlock Premium Listings</h3>
          <p style="opacity: 0.7; font-size: 14px; margin-bottom: 20px;">Post unlimited properties, get verified badge, priority placement, and lead analytics.</p>
          <a href="pricing.html" class="dash-btn" style="text-decoration:none; display:inline-block;">Upgrade Now - View Plans</a>
        </div>
      </div>
    </div>

    <!-- Section 2: My Profile -->
    <div class="dash-section" id="sec-profile">
      <div class="dash-card">
        <div class="dash-card-title">My Profile <button class="dash-btn" id="btnSaveProfile">Save Changes</button></div>
        
        <div style="display:flex; gap:24px; margin-bottom: 24px; align-items:center;">
          <img src="" id="profileImgPreview" style="width:80px; height:80px; border-radius:50%; object-fit:cover; background:var(--bg); border: 1px solid var(--border)">
          <div>
            <label class="dash-btn dash-btn-outline" style="cursor:pointer;">
              <i class="fa-solid fa-camera"></i> Change Photo
              <input type="file" id="profileUpload" accept="image/*" style="display:none;">
            </label>
            <p style="font-size:12px; color:var(--text-muted); margin-top:8px;">JPG, PNG or GIF. Max size of 800K</p>
          </div>
        </div>
        
        <div class="dash-form-grid">
          <div class="dash-form-group">
            <label class="dash-label">Full Name</label>
            <input type="text" id="profName" class="dash-input" placeholder="Enter full name">
          </div>
          <div class="dash-form-group">
            <label class="dash-label">Email Address (Readonly)</label>
            <input type="email" id="profEmail" class="dash-input" disabled style="background:#f9fafb">
          </div>
          <div class="dash-form-group">
            <label class="dash-label">Mobile Number</label>
            <input type="text" id="profMobile" class="dash-input" placeholder="+91 xxxxxxxxxx">
          </div>
          <div class="dash-form-group">
            <label class="dash-label">Company Name</label>
            <input type="text" id="profCompany" class="dash-input" placeholder="Your agency or firm name">
          </div>
          <div class="dash-form-group full">
            <label class="dash-label">Office Address</label>
            <input type="text" id="profAddress" class="dash-input" placeholder="Full office address">
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3: My Properties -->
    <div class="dash-section" id="sec-properties">
      <div class="dash-card">
        <div class="dash-card-title">My Properties 
          <a href="post-property.html" class="dash-btn" style="text-decoration:none"><i class="fa-solid fa-plus"></i> Post New Property</a>
        </div>
        <div id="myPropertiesList">
          <div class="dash-empty">Loading your properties...</div>
        </div>
      </div>
    </div>

    <!-- Section: My Leads -->
    <div class="dash-section" id="sec-leads">
      <div class="dash-card">
        <div class="dash-card-title">Leads on My Properties</div>
        <div id="myLeadsList">
           <div class="dash-empty">Loading your leads...</div>
        </div>
      </div>
    </div>

    <!-- Section 4: Plan & Subscriptions -->
    <div class="dash-section" id="sec-plans">
      <div class="dash-card">
        <div class="dash-card-title">Current Plan</div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h2 style="font-size:24px; color:var(--dark); margin:0 0 6px;" id="planNameDisplay">Free Plan</h2>
            <p style="color:var(--text-muted); font-size:14px; margin:0;" id="planExpiryDisplay">Basic listing privileges. Featured properties excluded.</p>
          </div>
          <a href="pricing.html" class="dash-btn dash-btn-outline" style="text-decoration:none;">Upgrade Plan</a>
        </div>
      </div>
    </div>

    <!-- Section 5: Payment History -->
    <div class="dash-section" id="sec-payments">
      <div class="dash-card">
        <div class="dash-card-title">Payment History</div>
        <div class="table-wrap">
          <table class="dash-table">
            <thead>
              <tr>
                <th>Invoice ID</th>
                <th>Date</th>
                <th>Plan Detail</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="paymentHistoryBody">
              <tr>
                <td colspan="5" class="dash-empty" style="padding:24px">No payments found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Section 6: RERA Verification -->
    <div class="dash-section" id="sec-rera">
      <div class="dash-card">
        <div class="dash-card-title">RERA Verification <span class="badge" id="reraStatusBadge">Unverified</span></div>
        <p style="font-size:14px; color:var(--text-muted); margin-bottom:20px;">Boost your trust by verifying your real estate license.</p>
        
        <div class="dash-form-grid">
          <div class="dash-form-group full">
            <label class="dash-label">RERA Registration Number</label>
            <input type="text" id="reraNumber" class="dash-input" placeholder="Enter Registration No.">
          </div>
          <div class="dash-form-group full">
            <label class="dash-label">Upload Certificate</label>
            <input type="file" id="reraFile" class="dash-input" accept=".pdf,image/*">
            <p style="font-size:12px; color:var(--text-muted); margin-top:4px;">Upload PDF or Image copy of your RERA certificate.</p>
          </div>
          <div class="dash-form-group full">
             <button class="dash-btn" id="btnSubmitRera" style="max-width:200px">Submit for Verification</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 7: Notifications -->
    <div class="dash-section" id="sec-notifications">
      <div class="dash-card">
        <div class="dash-card-title">Notifications & Activity</div>
        <div>
          <div class="notify-item">
            <div class="notify-icon"><i class="fa-solid fa-hands-clapping"></i></div>
            <div class="notify-content">
              <p>Welcome to 24Dismil.com!</p>
              <span>Just now</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 8: Settings -->
    <div class="dash-section" id="sec-settings">
      <div class="dash-card">
        <div class="dash-card-title">Account Settings</div>
        
        <div class="setting-row">
          <div class="setting-info">
            <h4>Email Notifications</h4>
            <p>Receive alerts about leads and property approvals.</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="setToggleEmail" checked>
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-row">
          <div class="setting-info">
            <h4>SMS Notifications</h4>
            <p>Get instant updates on your mobile phone.</p>
          </div>
          <label class="switch">
            <input type="checkbox" id="setToggleSms">
            <span class="slider"></span>
          </label>
        </div>
        
        <div class="setting-row" style="border-bottom:none; margin-top:16px;">
          <div class="setting-info">
            <h4 style="color:#B91C1C">Deactivate Account</h4>
            <p>Permanently remove your account and all listed properties.</p>
          </div>
          <button class="dash-btn" style="background:#FEE2E2; color:#B91C1C;">Deactivate</button>
        </div>
        
        <div class="dash-form-group full" style="margin-top:24px;">
           <button class="dash-btn" id="btnSaveSettings" style="max-width:200px">Save Settings</button>
        </div>
        
      </div>
    </div>
    
  </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="js/properties.js"></script>
<script src="js/main.js"></script>
<script type="module">
  import { requireAuth, logout, getCachedUser } from './js/auth.js';
  import { convex } from './js/convex.js';
  import { getToken } from './js/auth.js';

  const user = await requireAuth('login.html');
  if (!user) throw new Error('Not logged in');

  // Nav
  document.getElementById('dashNavName').innerHTML = `<i class="fa-solid fa-user"></i> ${user.name.split(' ')[0]}`;
  document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
    e.preventDefault();
    await logout();
    window.location.href = 'index.html';
  });

  // Stats
  document.getElementById('dashGreeting').innerHTML = `Welcome back, ${user.name.split(' ')[0]}! <i class="fa-solid fa-hand"></i>`;
  document.getElementById('dashEmail').textContent = user.email;
  
  // Load properties first to calculate counts
  const token = getToken();
  let properties = [];
  try {
    console.log("Fetching properties...");
    properties = await convex.query('auth:getMyProperties', { token });
    console.log("Fetched properties:", properties);
  } catch (err) {
    console.error("Failed to fetch properties:", err);
    console.warn("Failed to fetch properties:", err);
  }
  const propertyCount = properties ? properties.length : 0;
  
  document.getElementById('statPosted').textContent = propertyCount;
  
  const limit = user.limit || 1;
  const limitLeft = Math.max(0, limit - propertyCount);
  document.getElementById('statFreeLeft').textContent = limitLeft;
  
  // Set Tier Badge
  const t = user.subscriptionTier;
  const iconEl = document.getElementById('tierIconContainer');
  if (t === 'premium') iconEl.innerHTML = '<i class="fa-solid fa-star" style="color:#FFD700"></i>';
  else if (t?.startsWith('agent')) iconEl.innerHTML = '<i class="fa-solid fa-briefcase"></i>';
  else iconEl.innerHTML = '<i class="fa-solid fa-tag"></i>';

  const tierName = user.subscriptionTier || 'free';
  document.querySelectorAll('.dash-stat-label')[2].textContent = (tierName.charAt(0).toUpperCase() + tierName.slice(1)) + ' Plan';

  document.getElementById('usageText').textContent = `${propertyCount} of ${limit} used`;
  const pct = Math.min(100, Math.round((propertyCount / limit) * 100));
  document.getElementById('usageBar').style.width = pct + '%';
  document.getElementById('usageBar').style.background = pct >= 100 ? '#EF4444' : 'var(--primary)';

  // Conditional Upgrade Banner
  if (user.subscriptionTier === 'free') {
    document.getElementById('upgradeCard').style.display = 'block';
  } else {
    const pStatus = document.querySelector('#sec-dashboard .dash-card p');
    if (pStatus) pStatus.textContent = `You are on the ${tierName} plan. Your listings will be featured automatically!`;
  }

  const list = document.getElementById('myPropertiesList');

  if (!properties || properties.length === 0) {
    list.innerHTML = `<div class="dash-empty">
      <div style="font-size:40px;margin-bottom:12px"><i class="fa-solid fa-house"></i></div>
      <p style="font-weight:700;color:var(--dark)">No properties listed yet</p>
      <p style="font-size:13px">Post your first property to get started!</p>
      <a href="post-property.html" class="btn btn-primary" style="margin-top:14px;display:inline-block"><i class="fa-solid fa-plus"></i> Post Property</a>
    </div>`;
  } else {
    list.innerHTML = properties.map(p => `
      <div class="dash-prop-card" style="cursor: pointer; ${p.isFeatured ? 'border: 2px solid var(--primary);' : ''}" onclick="window.location.href='property-detail.html?id=${p._id}'">
        <img class="dash-prop-img" src="${p.photos?.[0] || 'images/property-1.webp'}" alt="${p.details?.bhk} BHK ${p.propertyType}" onerror="this.src='images/property-1.webp'">
        <div class="dash-prop-info">
          <div class="dash-prop-title">
            ${p.details?.bhk && p.details.bhk!=='N/A' && p.details.bhk!=='0' ? p.details.bhk + ' BHK ' : ''}${p.propertyType || ''} in ${p.location?.locality || ''}
          </div>
          <div class="dash-prop-loc"><i class="fa-solid fa-location-dot"></i> ${p.location?.city || ''}, ${p.location?.state || ''}</div>
          
          <div style="margin-top:8px">
            <span style="font-size:12px; color:var(--text-muted)">Posted on: ${new Date(p._creationTime).toLocaleDateString('en-IN')}</span>
            <br>
            ${(() => {
              if (p.isFeatured) return '<span class="prop-status-tag status-featured"><i class="fa-solid fa-star"></i> Featured Posting</span>';
              const activationTime = p.lastActivatedAt || p._creationTime;
              const diff = Date.now() - activationTime;
              const daysUsed = Math.floor(diff / (1000 * 60 * 60 * 24));
              const daysLeft = Math.max(0, 30 - daysUsed);
              if (daysLeft <= 0) return '<span class="prop-status-tag" style="background:#fee2e2;color:#b91c1c">Expired (30 days limit)</span>';
              return `<span class="prop-status-tag ${daysLeft < 7 ? 'status-expiry' : 'status-active'}">${daysLeft} days remaining</span>`;
            })()}
          </div>

          <div class="dash-prop-actions">
            ${(() => {
              const activationTime = p.lastActivatedAt || p._creationTime;
              const daysUsed = Math.floor((Date.now() - activationTime) / (1000 * 60 * 60 * 24));
              if (daysUsed >= 30) {
                return `<button class="dash-action-btn btn-reactivate-prop" style="background:var(--primary); color:#fff; border-color:var(--primary)" data-id="${p._id}" onclick="event.stopPropagation()"><i class="fa-solid fa-rotate-right"></i> Reactivate</button>`;
              }
              return '';
            })()}
            <a href="post-property.html?id=${p._id}" class="dash-action-btn" onclick="event.stopPropagation()"><i class="fa-solid fa-pen-to-square"></i> Edit</a>
            <button class="dash-action-btn danger btn-delete-prop" data-id="${p._id}" onclick="event.stopPropagation()"><i class="fa-solid fa-trash"></i> Delete</button>
          </div>
        </div>
        <div class="dash-prop-price">â‚¹${(p.pricing?.expectedPrice || 0).toLocaleString('en-IN')}</div>
      </div>
    `).join('');

    // Attach Delete Listeners
    document.querySelectorAll('.btn-delete-prop').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this property? This action cannot be undone.')) {
          try {
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;
            await convex.mutation('properties:deleteProperty', { token, id });
            window.location.reload();
          } catch (err) {
            alert('Error deleting property: ' + err.message);
            btn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete';
            btn.disabled = false;
          }
        }
      });
    });

    // Attach Reactivate Listeners
    document.querySelectorAll('.btn-reactivate-prop').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.getAttribute('data-id');
        try {
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Reactivating...';
          btn.disabled = true;
          await convex.mutation('properties:reactivateProperty', { token, id });
          if (typeof window.showToast === 'function') window.showToast('Property reactivated for 30 days!', 'success');
          setTimeout(() => window.location.reload(), 1500);
        } catch (err) {
          alert('Error: ' + err.message);
          btn.innerHTML = '<i class="fa-solid fa-rotate-right"></i> Reactivate';
          btn.disabled = false;
        }
      });
    });
  }

  // Load Leads
  let leads = [];
  try {
    console.log("Fetching leads...");
    leads = await convex.query('properties:getMyLeads', { token });
    console.log("Fetched leads:", leads);
  } catch (err) {
    console.error("Failed to fetch leads:", err);
    console.warn("Failed to fetch leads:", err);
  }
  const leadsList = document.getElementById('myLeadsList');
  if (!leads || leads.length === 0) {
    leadsList.innerHTML = `<div class="dash-empty">
      <div style="font-size:40px;margin-bottom:12px;opacity:0.3"><i class="fa-solid fa-users-viewfinder"></i></div>
      <p style="font-weight:700;color:var(--dark)">No leads generated yet</p>
      <p style="font-size:13px">Your property enquiries will appear here. Upgrade your plan to boost visibility!</p>
    </div>`;
  } else {
    leadsList.innerHTML = leads.map(l => {
      const date = new Date(l._creationTime);
      const initials = l.inquirerName ? l.inquirerName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : '?';
      const waMsg = encodeURIComponent(`Hi ${l.inquirerName}, I am the owner of the property "${l.propertyTitle}" you enquired about on 24Dismil.com. Are you interested in discussing further?`);
      
      // Helper to parse the structured message
      const parseLeadMessage = (msg) => {
        if (!msg) return { chips: [], raw: '' };
        if (!msg.includes('--- Advertiser Modal Enquiry ---')) return { chips: [], raw: msg };
        
        const cleanMsg = msg.replace('--- Advertiser Modal Enquiry ---', '').trim();
        const parts = cleanMsg.split(/Reason to Buy:|Property Dealer:|Planning to Buy In:|Interested in Home Loan:|Interested in Site Visit:/g).map(p => p.trim()).filter(Boolean);
        const keys = ['Reason to Buy', 'Property Dealer', 'Planning to Buy In', 'Interested in Home Loan', 'Interested in Site Visit'];
        
        // Re-extract since split loses the key names
        const chips = [];
        keys.forEach(k => {
          const match = cleanMsg.match(new RegExp(`${k}:\\s*(.*?)(?=${keys.join(':|')}:|$)`, 'i'));
          if (match && match[1]) {
            chips.push({ label: k, value: match[1].trim() });
          }
        });
        
        return { chips, raw: chips.length === 0 ? cleanMsg : '' };
      };

      const parsed = parseLeadMessage(l.message);
      
      return `
        <div class="lead-card">
          <div class="lead-header">
            <div class="lead-avatar">${initials}</div>
            <div class="lead-user-info">
              <h3>${l.inquirerName}</h3>
              <div class="lead-time"><i class="fa-regular fa-clock"></i> Received on ${date.toLocaleDateString('en-IN')} at ${date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
            <div class="lead-badge badge primary">New Enquiry</div>
          </div>
          
          <div class="lead-body">
            <a href="property-detail.html?id=${l.propertyId}" class="lead-prop-link">
              <i class="fa-solid fa-house-circle-check"></i>
              <div class="lead-prop-title-text">
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:2px">Enquiry For</div>
                ${l.propertyTitle}
              </div>
              <i class="fa-solid fa-chevron-right" style="font-size:12px; opacity:0.3"></i>
            </a>
            
            <div class="lead-meta">
              <a href="tel:${l.inquirerPhone}" class="lead-meta-item"><i class="fa-solid fa-phone-volume"></i> ${l.inquirerPhone}</a>
              ${l.inquirerEmail ? `<a href="mailto:${l.inquirerEmail}" class="lead-meta-item"><i class="fa-solid fa-envelope-open"></i> ${l.inquirerEmail}</a>` : ''}
            </div>
            
            ${parsed.chips.length > 0 ? `
              <div class="enquiry-grid">
                ${parsed.chips.map(c => `
                  <div class="enquiry-chip">
                    <span class="enquiry-label">${c.label}</span>
                    <span class="enquiry-value">${c.value}</span>
                  </div>
                `).join('')}
              </div>
            ` : parsed.raw ? `<div class="enquiry-raw-msg">${parsed.raw}</div>` : ''}
          </div>
          
          <div class="lead-footer-actions">
            <a href="tel:${l.inquirerPhone}" class="lead-action-btn btn-call-lead"><i class="fa-solid fa-phone"></i> Call Now</a>
            <a href="https://wa.me/91${l.inquirerPhone.replace(/\D/g, '')}?text=${waMsg}" target="_blank" class="lead-action-btn btn-wa-lead"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          </div>
        </div>
      `;
    }).join('');
  }

  // Sidebar Logic
  const navItems = document.querySelectorAll('.dash-nav-item');
  const sections = document.querySelectorAll('.dash-section');

  navItems.forEach(item => {
    item.addEventListener('click', () => {
      navItems.forEach(n => n.classList.remove('active'));
      sections.forEach(s => s.classList.remove('active'));
      
      item.classList.add('active');
      const targetId = 'sec-' + item.getAttribute('data-section');
      document.getElementById(targetId).classList.add('active');
      
      if (window.innerWidth <= 900) {
        window.scrollTo({ top: document.querySelector('.dash-content-wrap').offsetTop - 20, behavior: 'smooth' });
      }
    });
  });

  // Pre-fill Profile Data
  if(user.name) document.getElementById('profName').value = user.name;
  if(user.email) document.getElementById('profEmail').value = user.email;
  if(user.mobile) document.getElementById('profMobile').value = user.mobile;
  if(user.companyName) document.getElementById('profCompany').value = user.companyName;
  if(user.officeAddress) document.getElementById('profAddress').value = user.officeAddress;
  
  const defaultAvatar = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name) + '&background=random';
  document.getElementById('profileImgPreview').src = user.profilePictureUrl || defaultAvatar;

  // Pre-fill Plan info in section 4
  document.getElementById('planNameDisplay').textContent = (tierName.charAt(0).toUpperCase() + tierName.slice(1)) + ' Plan';
  if (user.subscriptionExpiry) {
    document.getElementById('planExpiryDisplay').textContent = 'Valid until: ' + new Date(user.subscriptionExpiry).toLocaleDateString();
  } else {
    document.getElementById('planExpiryDisplay').textContent = tierName === 'free' ? 'Basic listing privileges.' : 'Lifetime Access / No Expiry specified.';
  }

  // Pre-fill RERA info
  if(user.reraNumber) document.getElementById('reraNumber').value = user.reraNumber;
  if(user.reraStatus) {
    const badge = document.getElementById('reraStatusBadge');
    badge.textContent = user.reraStatus.toUpperCase();
    badge.className = 'badge ' + (user.reraStatus === 'verified' ? 'success' : (user.reraStatus==='pending' ? 'pending' : 'danger'));
  }

  // Pre-fill Settings info
  if(user.settings) {
    document.getElementById('setToggleEmail').checked = !!user.settings.emailNotifications;
    document.getElementById('setToggleSms').checked = !!user.settings.smsNotifications;
  }

  // --- EVENT LISTENERS FOR SAVING ---
  let currentProfilePicUrl = user.profilePictureUrl || '';
  let cropper;
  
  document.getElementById('profileUpload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Show preview and open crop modal
    const url = URL.createObjectURL(file);
    document.getElementById('cropImage').src = url;
    document.getElementById('cropModalOverlay').classList.add('open');
    
    if (cropper) cropper.destroy();
    cropper = new Cropper(document.getElementById('cropImage'), {
      aspectRatio: 1,
      viewMode: 1,
    });
    
    e.target.value = ''; // Reset input
  });

  document.getElementById('btnCancelCrop').addEventListener('click', () => {
    document.getElementById('cropModalOverlay').classList.remove('open');
    if (cropper) cropper.destroy();
  });

  document.getElementById('btnApplyCrop').addEventListener('click', async () => {
    if (!cropper) return;
    const btn = document.getElementById('btnApplyCrop');
    btn.textContent = 'Uploading...'; btn.disabled = true;
    
    cropper.getCroppedCanvas({ width: 400, height: 400 }).toBlob(async (blob) => {
      try {
        const uploadUrl = await convex.mutation("files:generateUploadUrl", {});
        const response = await fetch(uploadUrl, {
          method: "POST",
          headers: { "Content-Type": "image/jpeg" },
          body: blob
        });
        const { storageId } = await response.json();
        currentProfilePicUrl = await convex.query("files:getFileUrl", { storageId });
        
        // Update final preview
        document.getElementById('profileImgPreview').src = currentProfilePicUrl;
        
        document.getElementById('cropModalOverlay').classList.remove('open');
        if (typeof window.showToast === 'function') window.showToast("Image cropped & uploaded!", "success");
      } catch (err) {
        console.error(err);
        if (typeof window.showToast === 'function') window.showToast("Failed to upload image", "error");
      } finally {
        btn.textContent = 'Apply & Upload'; btn.disabled = false;
        if (cropper) cropper.destroy();
      }
    }, 'image/jpeg', 0.8);
  });

  document.getElementById('btnSaveProfile').addEventListener('click', async () => {
    try {
      const btn = document.getElementById('btnSaveProfile');
      btn.textContent = 'Saving...'; btn.disabled = true;
      
      await convex.mutation('auth:updateProfile', { 
        token, 
        name: document.getElementById('profName').value, 
        mobile: document.getElementById('profMobile').value, 
        companyName: document.getElementById('profCompany').value, 
        officeAddress: document.getElementById('profAddress').value,
        profilePictureUrl: currentProfilePicUrl
      });
      
      // If window.showToast exists from main.js, use it, else alert
      if (typeof window.showToast === 'function') window.showToast('Profile updated!', 'success');
      else alert('Profile updated!');
      
    } catch(err) {
      alert('Error: ' + err.message);
    } finally {
      document.getElementById('btnSaveProfile').textContent = 'Save Changes';
      document.getElementById('btnSaveProfile').disabled = false;
    }
  });

  document.getElementById('btnSubmitRera').addEventListener('click', async () => {
    try {
       const num = document.getElementById('reraNumber').value;
       if (!num) return alert('Enter RERA Number');
       
       const btn = document.getElementById('btnSubmitRera');
       btn.textContent = 'Submitting...'; btn.disabled = true;
       
       await convex.mutation('auth:submitRera', { token, reraNumber: num });
       
       const badge = document.getElementById('reraStatusBadge');
       badge.textContent = 'PENDING';
       badge.className = 'badge pending';
       if (typeof window.showToast === 'function') window.showToast('RERA Submitted!', 'success');
       else alert('RERA Submitted!');
       
    } catch (err) {
       alert('Error: ' + err.message);
    } finally {
       document.getElementById('btnSubmitRera').textContent = 'Submit for Verification';
       document.getElementById('btnSubmitRera').disabled = false;
    }
  });

  document.getElementById('btnSaveSettings').addEventListener('click', async () => {
    try {
       const btn = document.getElementById('btnSaveSettings');
       btn.textContent = 'Saving...'; btn.disabled = true;
       
       await convex.mutation('auth:updateSettings', { 
         token, 
         emailNotifications: document.getElementById('setToggleEmail').checked, 
         smsNotifications: document.getElementById('setToggleSms').checked 
       });
       if (typeof window.showToast === 'function') window.showToast('Settings Saved', 'success');
       else alert('Settings Saved');
       
    } catch (err) {
       alert('Error: ' + err.message);
    } finally {
       document.getElementById('btnSaveSettings').textContent = 'Save Settings';
       document.getElementById('btnSaveSettings').disabled = false;
    }
  });

  document.getElementById('dashWrap').style.display = 'flex';
</script>
<script src="js/city-selector.js"></script>

</body>
</html>
